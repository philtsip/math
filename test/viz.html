<html>
<head>
<!-- <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script> -->
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="highcharts.js"></script>
<script type="text/javascript" src="./../array.math.js"></script>
<script type="text/javascript" src="./../chart.math.js"></script>
<script type="text/javascript" src="./../node_modules/histogramjs/histogram.js"></script>

<!-- <script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script> -->
<!-- <script type="text/javascript" src="https://canvg.googlecode.com/svn-history/r157/trunk/canvg.js"></script> -->
<!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'> -->

<!--<script type="text/javascript">

  // SVG TO IMAGE CONVERSION FUNCTIONS
  function getImgData(chartContainer) {
    var chartArea = chartContainer.getElementsByTagName('svg')[0].parentNode;
    var svg = chartArea.innerHTML;
    var doc = chartContainer.ownerDocument;
    var canvas = doc.createElement('canvas');
    canvas.setAttribute('width', chartArea.offsetWidth);
    canvas.setAttribute('height', chartArea.offsetHeight);

    canvas.setAttribute(
        'style',
        'position: absolute; ' +
        'top: ' + (-chartArea.offsetHeight * 2) + 'px;' +
        'left: ' + (-chartArea.offsetWidth * 2) + 'px;');
    doc.body.appendChild(canvas);
    canvg(canvas, svg);
    var imgData = canvas.toDataURL("image/png");
    canvas.parentNode.removeChild(canvas);
    return imgData;
  }

  function saveAsImg(chartContainer) {
    var imgData = getImgData(chartContainer);

    // Replacing the mime-type will force the browser to trigger a download
    // rather than displaying the image in the browser window.
    window.location = imgData.replace("image/png", "image/octet-stream");
  }

  function toImg(containerID) {
	var chartContainer = document.getElementById(containerID);  // NEW
	var imgContainer = chartContainer;  // NEW -- Assume both input and output to be the same

    var doc = chartContainer.ownerDocument;
    var img = doc.createElement('img');
    img.src = getImgData(chartContainer);
	img.id = (containerID + "_img");

    while (imgContainer.firstChild) {
      imgContainer.removeChild(imgContainer.firstChild);
    }
    imgContainer.appendChild(img);
  }
</script>

 -->
<script type="text/javascript">
$(function() {
	
//  HIGHCHARTS SETUP
	function generateChart(template, chart_meta, chart_data) {
		return $.extend(true, {}, template, chart_meta, chart_data);
	}
	
	// style: CSSObject. Defaults to {"color": "contrast", "fontSize": "11px", "fontWeight": "bold", "textShadow": "0 0 6px contrast, 0 0 3px contrast" }.  contrast = contrasting color

	var default_style =  {
	                        color: 'black',
							// fontSize: '11px',
							fontFamily: "'Open Sans', Arial, sans-serif",
							fontWeight: 'normal',
							textShadow: 'none'
	                  };

	function chartTemplate (type) {
		if (type == "histogram") 
			return 	{
				chart: {
					type: 'column',
					animation: false,
					style: default_style
				},
				title: {
					style: {
						fontSize: '15px',
						fontFamily: "'Open Sans', Arial, sans-serif",
						fontWeight: '700'
					}

				},
				xAxis: {
					labels: {
						style: default_style,
						align: 'right',
						autoRotation: [-45],
						// autoRotation: [0],
						// staggerLines: 2,
						formatter: function() {
						  return Math.round(this.value * 100) + '%';
						}
					}
		            // tickmarkPlacement: 'on'

				},
				yAxis: {
					min: 0,
					title: {
						style: default_style
					},
					// gridLineWidth: 0,
					labels: {
						style: default_style
					},
					stackLabels: {
						enabled: true,
						style: default_style,
						formatter: function() {
							if (this.total != 0) {
								return this.total;
							} else {
								return null;
							}
						}
						
					}
				},
				legend: {
					enabled: false,
					x: 30,
					verticalAlign: 'bottom',
					floating: false,
					borderColor: '#d4d4d4',
					borderWidth: 1,
					shadow: false,
					itemStyle: default_style
				},
				tooltip: {
					enabled: false
				},
				plotOptions: {
					series: {
						animation: false,                
						borderWidth: 1,
		                borderColor: '#dddddd',
						// backgroundColor: 'rgba(252, 255, 197, 0.7)'

					},
					column: {
						stacking: 'normal',
			            groupPadding: 0,
			            pointPadding: 0,
			            borderWidth: 0,
						dataLabels: {
							enabled: false,
							// color: 'black',
							style: default_style,
							formatter: function() {
								if (this.y != 0) {
									return this.y;
								} else {
									return null;
								}
							}
						}
					}
				},
				credits: {
					enabled: true,
					position: {
						align: 'left',
						x: 15,
						verticalAlign: 'bottom',
						y: -20
					},
					style: {
						// cursor: 'pointer',
						// color: '#909090',
						fontSize: '9px',
						fontFamily: "'Open Sans', Arial, sans-serif",
					}
				}
			}
		
		else
			return null;
	}	
	
//  HIGHCHARTS DATA

	function chartMeta() {
		return {
			colors: ['#8085e9', '#f15c80', '#e4d354', '#8085e8', '#8d4653', '#91e8e1'],
			credits: {
				text: "",
				// href: 'http://dataflip.heroku.com/'
			}
		}
	
	}
	
	function chartData(title, chart_data) {
		var zero_line = chart_data.x.indexOf(0)-.5;
		
		return {
			
			title: {
				text:  title
			},
			yAxis: {
				title: {
					text: '# '
				}
			},
			xAxis: {
				title: {
					text: '% total return',
				},
				categories: chart_data.x,
	            plotLines: [{
	                color: '#FF0000',
	                width: 2,
	                value: zero_line,
					dashStyle: 'dash'
	            }]
				
			},
			series: [{
						name: "10yr returns",
						data: chart_data.y
					}]		
		}	
	}

// HISTOGRAM
	
	// CONSTANTS

	var url = './sp_monthly.json';
	var metric = "adj_close";

	var values = [], xAxis = {}, min, max, ticks, buckets, x, y = [], data, histoData = {}, log = "";

	var comparisons_eng = ["monthly", "annual", "5yr", "7yr", "10yr", "20yr"];
	var comparisons = [1,12,60,84,120,240];

	//  MAIN
	$.getJSON(url, function(body, textStatus, jqXHR) {
		console.log(url + " loaded successfully");

		var series = body;
		var column = series.meta.columns.indexOf(metric); 

		for (var i = 0; i < comparisons.length; i++) {

			values = am.percentdiffArray(series.data[column],comparisons[i]);	

			xAxis = cm.dimensions(values);

			min = xAxis.min;
			max = xAxis.max;
			ticks = Math.round((xAxis.max-xAxis.min)/xAxis.ticksize);  // to prevent floating point values
			buckets = ticks * Math.floor(10/ticks); // get to 10 or less buckets
	
			console.log(comparisons_eng[i] + " returns");
			console.log("Average return: " + am.toP(am.meanArray(values),1));
			console.log(min + " " + max);
			console.log(ticks);
			console.log(buckets);

			x = cm.linspace(min, max, buckets);
			y = values;

			data = histogram({
			    data : y,
			    bins : x
			})
			
			histoData = cm.histogramData(data);
			
			$("body").append('<div id="' + ('chart_' + comparisons[i]) + '" style="width: 550px; height: 400px; margin: 0 auto"></div>');
			$(('#chart_' + comparisons[i])).highcharts(generateChart(chartTemplate("histogram"), chartMeta(), chartData((comparisons_eng[i] + " returns"),histoData)));

			console.log(JSON.stringify(histoData));

			console.log("");
		}
	})
	.fail(function() {
		console.log( url + " failed to load" );
	});

		
	// CHART WIDTH SLIDER
    // $('#width').bind('input', function () {
    //     $('#chart').highcharts().setSize(this.value, 400, false);
    // });
	
	// CONVERT CHART TO IMAGE
	// $.when($('#chart').highcharts(generateChart(stacked_bar_template, num_mtg_chart_meta, num_mtg_chart_data))).done(toImg('chart'));
	
});
</script>

</head>
<body>
<!-- <input id="width" type="range" value="500" min="100" max="1000" /> -->
<!-- <div id="log"></div> -->
<!-- <button onclick="saveAsImg(document.getElementById('container1'));">Save as PNG Image</button>
<button onclick="toImg(document.getElementById('container2'), document.getElementById('container2'));">Convert to image</button> -->
</body>
</html>