<html>
<head>
<!-- <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script> -->
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="highcharts.js"></script>
<script type="text/javascript" src="./../array.math.js"></script>
<script type="text/javascript" src="./../date.math.js"></script>
<script type="text/javascript" src="./../chart.math.js"></script>
<script type="text/javascript" src="./../node_modules/histogramjs/histogram.js"></script>

<!-- <script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script> -->
<!-- <script type="text/javascript" src="https://canvg.googlecode.com/svn-history/r157/trunk/canvg.js"></script> -->
<!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'> -->

<!--<script type="text/javascript">

  // SVG TO IMAGE CONVERSION FUNCTIONS
  function getImgData(chartContainer) {
    var chartArea = chartContainer.getElementsByTagName('svg')[0].parentNode;
    var svg = chartArea.innerHTML;
    var doc = chartContainer.ownerDocument;
    var canvas = doc.createElement('canvas');
    canvas.setAttribute('width', chartArea.offsetWidth);
    canvas.setAttribute('height', chartArea.offsetHeight);

    canvas.setAttribute(
        'style',
        'position: absolute; ' +
        'top: ' + (-chartArea.offsetHeight * 2) + 'px;' +
        'left: ' + (-chartArea.offsetWidth * 2) + 'px;');
    doc.body.appendChild(canvas);
    canvg(canvas, svg);
    var imgData = canvas.toDataURL("image/png");
    canvas.parentNode.removeChild(canvas);
    return imgData;
  }

  function saveAsImg(chartContainer) {
    var imgData = getImgData(chartContainer);

    // Replacing the mime-type will force the browser to trigger a download
    // rather than displaying the image in the browser window.
    window.location = imgData.replace("image/png", "image/octet-stream");
  }

  function toImg(containerID) {
	var chartContainer = document.getElementById(containerID);  // NEW
	var imgContainer = chartContainer;  // NEW -- Assume both input and output to be the same

    var doc = chartContainer.ownerDocument;
    var img = doc.createElement('img');
    img.src = getImgData(chartContainer);
	img.id = (containerID + "_img");

    while (imgContainer.firstChild) {
      imgContainer.removeChild(imgContainer.firstChild);
    }
    imgContainer.appendChild(img);
  }
</script>

 -->
<script type="text/javascript">
$(function() {
	
//  HIGHCHARTS SETUP
	function generateChart(template, chart_meta, chart_data) {
		return $.extend(true, {}, template, chart_meta, chart_data);
	}
	
	// style: CSSObject. Defaults to {"color": "contrast", "fontSize": "11px", "fontWeight": "bold", "textShadow": "0 0 6px contrast, 0 0 3px contrast" }.  contrast = contrasting color

	var default_style =  {
	                        color: 'black', // fontSize: '11px',
							fontFamily: "'Open Sans', Arial, sans-serif", fontWeight: 'normal', textShadow: 'none'
	                     };

	function chartTemplate (type) {
		if (type == "histogram") 
			return 	{
				chart: {
					type: 'column',
					animation: false,
					style: default_style
				},
				title: {
					style: { fontSize: '15px', fontFamily: "'Open Sans', Arial, sans-serif", fontWeight: '700' }
				},
				xAxis: {
					title: {style: default_style },
					labels: { style: default_style, align: 'right', autoRotation: [-45],
						// autoRotation: [0],
						// staggerLines: 2,
						formatter: function() {
						  return Math.round(this.value * 100) + '%';
						}
					}
		            // tickmarkPlacement: 'on'

				},
				yAxis: {
					min: 0,
					title: { style: default_style },
		            // plotLines: [{
		            //     color: '#FFFFFF'
		            // }],
					// gridLineWidth: 0,
					labels: { style: default_style },
					stackLabels: { enabled: true, style: default_style,
						formatter: function() {
							if (this.total != 0) { 	return this.total; } 
							else { 	return null; }
						}
						
					}
				},
				legend: {
					enabled: false, x: 30, verticalAlign: 'bottom', floating: false, borderColor: '#d4d4d4', borderWidth: 1, shadow: false, itemStyle: default_style
				},
				tooltip: { enabled: false },
				plotOptions: {
					series: {
						animation: false, borderWidth: 1, borderColor: '#dddddd', // backgroundColor: 'rgba(252, 255, 197, 0.7)'
					},
					column: {
						stacking: 'normal', groupPadding: 0, pointPadding: 0, borderWidth: 0,
						dataLabels: {
							enabled: false, // color: 'black',
							style: default_style,
							formatter: function() {
								if (this.y != 0) { 	return this.y; 	} 
								else { 	return null; }
							}
						}
					}
				},
				credits: {
					enabled: true,
					position: { align: 'left', x: 15, verticalAlign: 'bottom', y: -20 },
					style: {
						// cursor: 'pointer',
						// color: '#909090',
						fontSize: '9px', fontFamily: "'Open Sans', Arial, sans-serif",
					}
				}
			}
		
			if (type == "line") 
				return 	{
					chart: {
						type: 'line',
						animation: false,
						style: default_style
					},
					title: {
						style: { fontSize: '15px', fontFamily: "'Open Sans', Arial, sans-serif", fontWeight: '700' }
					},
					xAxis: {
						title: {style: default_style },
			            type: 'datetime',
						tickInterval: 24 * 3600 * 1000 * 30,
						labels: { style: default_style, align: 'right', autoRotation: [-45],
							// autoRotation: [0],
							// staggerLines: 2,
						}
					},
					yAxis: {
						min: 0,
						title: { style: default_style },
						// gridLineWidth: 0,
						labels: { style: default_style },
					},
					legend: {
						enabled: false, x: 30, verticalAlign: 'bottom', floating: false, borderColor: '#d4d4d4', borderWidth: 1, shadow: false, itemStyle: default_style
					},
					tooltip: { 
						// xDateFormat: '%Y-%m-%d',
						headerFormat: '{point.x:%b %Y}<br />',
						pointFormat: 'S&P500: <b>{point.y:.0f}</b>' 
					},
					plotOptions: {
						series: {
							animation: false,
						},
			            line: {
			                marker: {
			                    enabled: false
			                },
			                dataLabels: {
			                    enabled: true,
								formatter: function() {
								                    if (this.point.x == this.series.data.length - 1) {
								                        return Math.round(this.y);
								                    } else {
								                        return null;
								                    }
								                }
			                },
			                // enableMouseTracking: false
			            }
					},
					credits: {
						enabled: true,
						position: { align: 'left', x: 15, verticalAlign: 'bottom', y: -20 },
						style: {
							// cursor: 'pointer',
							// color: '#909090',
							fontSize: '9px', fontFamily: "'Open Sans', Arial, sans-serif",
						}
					}
				}
		
		else
			return null;
	}	
	
//  HIGHCHARTS DATA

	function chartMeta() {
		return {
			colors: ['#8085e9', '#f15c80', '#e4d354', '#8085e8', '#8d4653', '#91e8e1'],
			credits: { text: "", // href: 'http://dataflip.heroku.com/'
			}
		}
	
	}
	
	function chartData(type, title, x_data, x_label, y_data, y_label) {
		if (type == "histogram") {
			var zero_line = am.roundArray(x_data,4).indexOf(0)-.5;
			
			return {
				title: { text:  title },
				xAxis: { 
					title: { text: x_label },
					categories: x_data,
	            	plotLines: [{ color: '#FF0000', width: 2, value: zero_line, dashStyle: 'dash' }]	
				},
				yAxis: { title: { text: y_label } },
				series: [{ data: y_data }]		
			}				
		}
		else
			return {
				title: { text:  title },
				xAxis: { 
					title: { text: x_label },
					categories: x_data,
				},
				yAxis: { title: { text: y_label } },
				series: [{ data: y_data }]		
			}	
	}

// CHARTS
	
	// CONSTANTS

	var url = "./sp_monthly.json";
	var metric = "adj_close";
	var startDate = document.getElementById("startDate").value;

	var log = "";
	
	var lineTrendData = {};
	var barReturnsData = {};
	var histoYvalues = [], histoXaxis = {}, histoBuckets, histoData, histoChartData = [];

	var comparisons_eng = ["monthly", "annual", "5yr", "7yr", "10yr", "20yr"];
	var comparisons = [1,12,60,84,120,240];

	var tests_eng = ["positive", "10%+", "less than -10%"];
	var tests = [">0", ">=.1", "<=-.1"];
	// var tests_eng = ["positive", "10%+", "less than -10%", "50%+", "less than -50%", "double"];
	// var tests = [">0", ">=.1", "<=-.1", ">=.5", "<=-.5", ">=1"];

	//  MAIN
	$.getJSON(url, function(body, textStatus, jqXHR) {
		console.log(url + " loaded successfully");

		var fullSeries = body;
		var series, column;
		
		series = dm.since(fullSeries, startDate);
		
		column = series.meta.columns.indexOf(metric); 

		// lineTrendData =
		$("#charts").append('<div id="' + ('chart_' + 'lineTrend') + '" style="width: 550px; height: 400px; margin: 0 auto"></div>');
		$(('#chart_' + 'lineTrend')).highcharts(generateChart(chartTemplate("line"), chartMeta(), chartData("line", "S&P Adj Close",dm.toJSDateArray(series.data[0]),"Date",series.data[column],"Adj Close")));
		
		
// HISTOGRAM

		for (var i = 0; i < comparisons.length; i++) {

			histoYvalues = am.percentdiffArray(series.data[column],comparisons[i]);
				
			if (histoYvalues != null) {
				
				histoXaxis = cm.dimensions(histoYvalues);

				if (histoXaxis.majorticks < 10)
					histoBuckets = histoXaxis.majorticks * Math.floor(10/histoXaxis.majorticks); // get to 10 or less histoBuckets
				else
					histoBuckets = histoXaxis.majorticks;
	
				console.log(comparisons_eng[i] + " returns");
				//
				// console.log(Math.min.apply(null, histoYvalues));
				// console.log(Math.max.apply(null, histoYvalues));
				//
				console.log(histoXaxis.min + " " + histoXaxis.max + " " + histoBuckets);
				// console.log(JSON.stringify(histoYvalues));
				// console.log(histoBuckets);

				histoData = histogram({
				    data : histoYvalues,
				    bins : cm.linspace(histoXaxis.min, histoXaxis.max, histoBuckets)
				})
			
				histoChartData = cm.toHistoChart(histoData);
				
				log = '';
				log += ( '<p>' + 'Average return: ' + am.toP(am.meanArray(histoYvalues),1) + '</p>' );

				for (var j = 0; j < tests.length; j++) {
					log += ( '<p>' + 'Probability ' + tests_eng[j] + ': ' + am.toP(am.percentif(histoYvalues,tests[j]),0) + '</p>' );
				}
			
				$("#charts").append('<div id="' + ('chart_' + comparisons[i]) + '" style="width: 550px; height: 400px; margin: 0 auto"></div>');
				$(('#chart_' + comparisons[i])).highcharts(generateChart(chartTemplate("histogram"), chartMeta(), chartData("histogram", (comparisons_eng[i] + " returns"),histoChartData[0],"% total return",histoChartData[1],"#")));
				$("#charts").append('<div id="' + ('log_' + comparisons[i]) + '" style="width: 550px; margin: 0 auto">' + log + '</div>');

				console.log("");
			}
		}
	})
	.fail(function() {
		console.log( url + " failed to load" );
	});

		
	// CHART WIDTH SLIDER
    // $('#width').bind('input', function () {
    //     $('#chart').highcharts().setSize(this.value, 400, false);
    // });
	
	// CONVERT CHART TO IMAGE
	// $.when($('#chart').highcharts(generateChart(stacked_bar_template, num_mtg_chart_meta, num_mtg_chart_data))).done(toImg('chart'));
	
});
</script>

</head>
<body>
<input type="text" id="startDate" value="1999/01/01">
<div id="charts"></div>
<!-- <input id="width" type="range" value="500" min="100" max="1000" /> -->
<!-- <div id="log"></div> -->
<!-- <button onclick="saveAsImg(document.getElementById('container1'));">Save as PNG Image</button>
<button onclick="toImg(document.getElementById('container2'), document.getElementById('container2'));">Convert to image</button> -->
</body>
</html>